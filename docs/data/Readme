# Data Formats

This document captures the canonical shapes that feed the core rules engine. Keep
files data-driven so quests, boards, and cards can be iterated without touching
code.

## Board Layouts

Boards describe geometry plus searchable regions:

```ts
type BoardState = {
  width: number;
  height: number;
  blocked: Vector2[]; // impassable tiles such as walls or closed doors
  areas: {
    id: string;
    name: string;
    kind: "room" | "corridor" | "exterior";
    tiles: Vector2[]; // every tile that belongs to the region
    allowedSearches?: Array<"traps" | "secret-doors" | "treasure">;
  }[];
  visibilityTriggers?: Array<
    {
      id: string;
      owner?:
        | { type: "actor"; actorId: string }
        | { type: "faction"; faction: "hero" | "monster" }
        | { type: "global" };
      areaIds?: string[];
      tiles?: Vector2[];
    } & (
      | { source: "door"; doorId: string }
      | { source: "script"; scriptId: string }
    )
  >;
};
```

- `blocked` tiles gate movement + line-of-sight.
- `areas` power searching, fog of war reveals, and quest scripting triggers.
- `visibilityTriggers` connect quest logic (doors, scripted reveals) to fog-of-war helpers. Each trigger piggybacks on the same data as `VisibilityTrigger` and can reveal explicit tiles or area IDs for a specific owner key (actor/faction/global).
- Use the same coordinate system across actors, discoverables, and tiles.

## Discoverables & Searching

Quests seed hidden content as discoverables. Each entry links to a board area and
is revealed through `search` actions.

```ts
type DiscoverableState = {
  id: string;
  areaId: string; // must match a board area
  type: "trap" | "secret-door" | "treasure";
  position: Vector2;
  revealed: boolean;
  data?: Record<string, unknown>; // quest-specific payload
};
```

`searchConfig` toggles validation rules:

- `requireHeroesOnly` (default `true`) – monsters cannot search.
- `requireNoEnemies` (default `true`) – actors must clear the area first.
- `historyMode` – `"per-area"` (group limit) or `"per-hero"` (each hero can search once).

`SearchPerformedEvent` emits `discoveries` every time new markers flip.

## Cards, Spells, and Equipment

Cards live under a quest/global catalog and are referenced by ID from actors.

```ts
type SpellDefinition = {
  id: string;
  name: string;
  school: string;
  target: {
    type: "self" | "ally" | "enemy";
    range: number;
    requiresLineOfSight?: boolean;
  };
  effects: Array<
    | { type: "damage"; amount: number }
    | { type: "heal"; amount: number }
    | { type: "move"; delta?: Vector2; destination?: Vector2; ignoreCollisions?: boolean }
    | { type: "buff"; stat: "attackDice" | "defenseDice" | "movement" | "maxHealth"; amount: number }
    | { type: "status"; effect: StatusEffectState }
    | {
        type: "statusModifier";
        stat: "attackDice" | "defenseDice" | "movement" | "maxHealth";
        amount: number;
        duration: number;
        id?: string;
        name?: string;
        tags?: string[];
      }
    | {
        type: "cleanse";
        statusIds?: string[];
        tags?: string[];
        removeAll?: boolean;
      }
  >;
};

type EquipmentDefinition = {
  id: string;
  name: string;
  slot: "weapon" | "armor" | "trinket" | "consumable";
  target: SpellDefinition["target"];
  effects: SpellDefinition["effects"];
  consumable?: boolean;
};
```

- Actors carry spell IDs in `knownSpells` and item IDs in `equipment`.
- `castSpell`/`useEquipment` actions rely entirely on the catalog; effects stay deterministic for tests.
- Consumable gear automatically removes itself from the actor inventory after use.
- `statusModifier` provides a shortcut for templated buffs/debuffs that also track duration/tags for later cleansing.
- `cleanse` removes matching status effects (by id or tag) and automatically rolls back any stat modifiers attached to them.

## Quest Bundles

A quest bundles:

1. **Board layout** – including areas and blocked tiles.
2. **Actors** – initial hero/monster stats and inventories.
3. **Discoverables/search config** – traps, hidden doors, treasure markers.
4. **Card catalogs** – spells/equipment referenced by actors.

Keep quest JSON focused on describing state; the rules engine handles validation,
events, and deterministic application.
